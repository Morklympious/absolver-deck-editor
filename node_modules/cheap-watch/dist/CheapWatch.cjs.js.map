{"version":3,"file":"CheapWatch.cjs.js","sources":["../CheapWatch.js"],"sourcesContent":["import EventEmitter from 'events';\nimport { readdir, stat, watch } from 'fs';\nimport { promisify } from 'util';\n\nconst readdirAsync = promisify(readdir);\nconst statAsync = promisify(stat);\n\nconst _watchers = Symbol('_watchers');\nconst _timeouts = Symbol('_timeouts');\nconst _queue = Symbol('_queue');\nconst _isProcessing = Symbol('_isProcessing');\nconst _isInited = Symbol('_isInited');\nconst _isClosed = Symbol('_isClosed');\nconst _recurse = Symbol('_recurse');\nconst _handle = Symbol('_handle');\nconst _enqueue = Symbol('_enqueue');\n\nexport default class CheapWatch extends EventEmitter {\n\tconstructor({ dir, filter, watch = true, debounce = 10 }) {\n\t\tif (typeof dir !== 'string') {\n\t\t\tthrow new TypeError('CheapWatch: dir must be a string');\n\t\t}\n\t\tif (filter && typeof filter !== 'function') {\n\t\t\tthrow new TypeError('CheapWatch: filter must be a function');\n\t\t}\n\t\tif (typeof watch !== 'boolean') {\n\t\t\tthrow new TypeError('CheapWatch: watch must be a boolean');\n\t\t}\n\t\tif (typeof debounce !== 'number') {\n\t\t\tthrow new TypeError('CheapWatch: debounce must be a number');\n\t\t}\n\t\tsuper();\n\t\t// root directory\n\t\tthis.dir = dir;\n\t\t// (optonal) function to limit watching to certain directories/files\n\t\tthis.filter = filter;\n\t\t// (optional) whether to actually watch for changes, or just report all matching files and their stats\n\t\tthis.watch = watch;\n\t\t// (optional) number of milliseconds to use to debounce events from FSWatcher\n\t\tthis.debounce = debounce;\n\t\t// paths of all directories -> FSWatcher instances\n\t\tthis[_watchers] = new Map();\n\t\t// paths of all files/dirs -> stats\n\t\tthis.paths = new Map();\n\t\t// paths of files with pending debounced events -> setTimeout timer ids\n\t\tthis[_timeouts] = new Map();\n\t\t// queue of pending FSWatcher events to handle\n\t\tthis[_queue] = [];\n\t\t// whether some FSWatcher event is currently already in the process of being handled\n\t\tthis[_isProcessing] = false;\n\t\t// whether init has been called\n\t\tthis[_isInited] = false;\n\t\t// whether close has been called\n\t\tthis[_isClosed] = false;\n\t}\n\n\t// recurse directroy, get stats, set up FSWatcher instances\n\t// returns array of { path, stats }\n\tasync init() {\n\t\tif (this[_isInited]) {\n\t\t\tthrow new Error('CheapWatch.init: Cannot be called twice');\n\t\t}\n\t\tthis[_isInited] = true;\n\t\tawait this[_recurse](this.dir);\n\t}\n\n\t// close all FSWatchers\n\tclose() {\n\t\tif (!this[_isInited]) {\n\t\t\tthrow new Error('CheapWatch.close: Cannot call before CheapWatch.init');\n\t\t}\n\t\tif (this[_isClosed]) {\n\t\t\tthrow new Error('CheapWatch.close: Cannot be called twice');\n\t\t}\n\t\tthis[_isClosed] = true;\n\t\tfor (const watcher of this[_watchers].values()) {\n\t\t\twatcher.close();\n\t\t}\n\t}\n\n\t// recurse a given directory\n\tasync [_recurse](full) {\n\t\tconst path = full.slice(this.dir.length + 1);\n\t\tconst stats = await statAsync(full);\n\t\tif (path) {\n\t\t\tif (this.filter && !await this.filter({ path, stats })) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.paths.set(path, stats);\n\t\t}\n\t\tif (stats.isDirectory()) {\n\t\t\tif (this.watch) {\n\t\t\t\tthis[_watchers].set(\n\t\t\t\t\tpath,\n\t\t\t\t\twatch(full, this[_handle].bind(this, full)).on('error', () => {}),\n\t\t\t\t);\n\t\t\t}\n\t\t\tawait Promise.all(\n\t\t\t\t(await readdirAsync(full)).map(sub => this[_recurse](full + '/' + sub)),\n\t\t\t);\n\t\t}\n\t}\n\n\t// handle FSWatcher event for given directory\n\t[_handle](dir, event, file) {\n\t\tconst full = dir + '/' + file;\n\t\tif (this[_timeouts].has(full)) {\n\t\t\tclearTimeout(this[_timeouts].get(full));\n\t\t}\n\t\tthis[_timeouts].set(\n\t\t\tfull,\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis[_timeouts].delete(full);\n\t\t\t\tthis[_enqueue](full);\n\t\t\t}, this.debounce),\n\t\t);\n\t}\n\n\t// add an FSWatcher event to the queue, and handle queued events\n\tasync [_enqueue](full) {\n\t\tthis[_queue].push(full);\n\t\tif (this[_isProcessing]) {\n\t\t\treturn;\n\t\t}\n\t\tthis[_isProcessing] = true;\n\t\twhile (this[_queue].length) {\n\t\t\tconst full = this[_queue].shift();\n\t\t\tconst path = full.slice(this.dir.length + 1);\n\t\t\ttry {\n\t\t\t\tconst stats = await statAsync(full);\n\t\t\t\tif (this.filter && !await this.filter({ path, stats })) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst isNew = !this.paths.has(path);\n\t\t\t\tthis.paths.set(path, stats);\n\t\t\t\tif (path) {\n\t\t\t\t\tthis.emit('+', { path, stats, isNew });\n\t\t\t\t}\n\t\t\t\tif (stats.isDirectory() && !this[_watchers].has(path)) {\n\t\t\t\t\t// note the new directory\n\t\t\t\t\t// start watching it, and report any files in it\n\t\t\t\t\tawait this[_recurse](full);\n\t\t\t\t\tfor (const [newPath, stats] of this.paths.entries()) {\n\t\t\t\t\t\tif (newPath.startsWith(path + '/')) {\n\t\t\t\t\t\t\tthis.emit('+', { path: newPath, stats, isNew: true });\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\t// check whether this is a deleted file/dir or just some FSWatcher artifact\n\t\t\t\tif (this.paths.has(path)) {\n\t\t\t\t\t// note the deleted file/dir\n\t\t\t\t\tconst stats = this.paths.get(path);\n\t\t\t\t\tthis.paths.delete(path);\n\t\t\t\t\tthis.emit('-', { path, stats });\n\t\t\t\t\tif (this[_watchers].has(path)) {\n\t\t\t\t\t\t// stop watching it, and report any files/dirs that were in it\n\t\t\t\t\t\tfor (const old of this[_watchers].keys()) {\n\t\t\t\t\t\t\tif (old === path || old.startsWith(path + '/')) {\n\t\t\t\t\t\t\t\tthis[_watchers].get(old).close();\n\t\t\t\t\t\t\t\tthis[_watchers].delete(old);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tfor (const old of this.paths.keys()) {\n\t\t\t\t\t\t\tif (old.startsWith(path + '/')) {\n\t\t\t\t\t\t\t\tconst stats = this.paths.get(old);\n\t\t\t\t\t\t\t\tthis.paths.delete(old);\n\t\t\t\t\t\t\t\tthis.emit('-', { path: old, stats });\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis[_isProcessing] = false;\n\t}\n}\n"],"names":["promisify","readdir","stat","watch"],"mappings":"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"}